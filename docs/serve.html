<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CityOS 高松</title>
  <style type="text/css">
    html,
    body,
    #map {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script type="text/javascript" src="https://geolonia.github.io/cityos-sdk/index.js"></script>
  <script type="application/javascript">

    const socket = new WebSocket('ws://localhost:___PORT___');

    const myCity = new city.Takamatsu.Map();

    myCity.on('load', () => {

      socket.addEventListener('message', (message) => {
        console.log(message.data);
        const id = 'live-geojson';
        const geojson = JSON.parse(message.data);

        myCity.addSource(id, {
          type: 'geojson',
          data: geojson,
        })

        // Add the geojson as layer to the map
        myCity.addLayer({
          id: id,
          type: 'circle',
          source: id,
          paint: {
            'circle-radius': 5,
            'circle-color': '#FF0000',
            'circle-opacity': 0.5,
          }
        }, 'poi');

        myCity.addLayer({
          "id": `symbol-${id}`,
          "type": "symbol",
          "source": id,
          "layout": {
            'text-field': "{名称}",
            "text-font": [
              "Noto Sans CJK JP Bold"
            ],
            'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
            'text-radial-offset': 0.5,
            'text-justify': 'auto',
            'text-size': 12,
            'text-anchor': 'top',
            'text-max-width': 12,
            'text-allow-overlap': false,
          },
          "paint": {
            "text-color": "#333",
            "text-halo-width": 1.2,
            "text-halo-color": "rgba(255,255,255,0.8)"
          }
        })
      });
    })
  </script>
</body>

</html>